<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Elbrus Training</title>
<link rel="manifest" href="manifest.json">
<style>
body {
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  background:#0b1220;
  color:white;
}

header {
  padding:20px;
  font-size:20px;
  font-weight:600;
  text-align:center;
  letter-spacing:1px;
}

.card {
  background:#111827;
  margin:16px;
  padding:16px;
  border-radius:16px;
}

select, input {
  width:100%;
  padding:8px;
  margin-top:6px;
  border-radius:8px;
  border:none;
  background:#1f2937;
  color:white;
}

button {
  width:100%;
  background:#22c55e;
  border:none;
  padding:10px;
  border-radius:10px;
  font-weight:600;
  margin-top:10px;
}

.ring-container {
  display:flex;
  justify-content:center;
  align-items:center;
  margin-top:10px;
}

svg {
  transform:rotate(-90deg);
}

.ring-bg {
  stroke:#1f2937;
}

.ring-progress {
  stroke:#22c55e;
  transition:stroke-dashoffset 0.4s ease;
}

.center-text {
  position:absolute;
  font-size:22px;
  font-weight:600;
}

.status {
  text-align:center;
  margin-top:10px;
  font-weight:600;
  letter-spacing:1px;
}

.green { color:#22c55e; }
.yellow { color:#facc15; }
.red { color:#ef4444; }

.small-info {
  font-size:13px;
  color:#94a3b8;
  margin-top:6px;
}
</style>
</head>
<body>

<header>ELBRUS SOUTH 2026</header>

<div class="card">
<label>Неделя</label>
<select id="weekSelector" onchange="changeWeek(this.value)"></select>
<div class="small-info" id="weekInfo"></div>
</div>

<div class="card">
<h3 style="text-align:center;">Индекс устойчивости</h3>
<div class="ring-container">
  <div style="position:relative;">
    <svg width="160" height="160">
      <circle cx="80" cy="80" r="70" stroke-width="12" fill="none" class="ring-bg"/>
      <circle id="ringProgress" cx="80" cy="80" r="70"
        stroke-width="12"
        fill="none"
        stroke-linecap="round"
        class="ring-progress"
        stroke-dasharray="440"
        stroke-dashoffset="440"/>
    </svg>
    <div class="center-text" id="ringText">0%</div>
  </div>
</div>
<div class="status" id="statusText"></div>
</div>

<div id="days"></div>

<script>
const TOTAL_WEEKS = 27;
const days = ["Пн","Вт","Ср","Чт","Пт","Сб","Вс"];

const Z2_MIN = 126;
const Z2_MAX = 134;
const Z3_MIN = 143;
const Z3_MAX = 151;

let currentWeek = 1;
let allData = JSON.parse(localStorage.getItem("elbrusData")) || {};

function getWeekTarget(week){
  if(week<=9) return {weight:5,long:"3:00"};
  if(week<=15) return {weight:6,long:"3:30"};
  if(week<=19) return {weight:7,long:"4:00"};
  if(week<=23) return {weight:8,long:"4:30"};
  if(week<=25) return {weight:9,long:"5:00"};
  if(week==26) return {weight:9,long:"6:30"};
  return {weight:6,long:"3:00"};
}

function getWeekData(week){
  if(!allData[week]){
    allData[week] = days.map(()=>({done:false, avg:0}));
  }
  return allData[week];
}

function pulseScore(i,p){
  if(p===0) return 0;
  if(i===3 && p>=Z3_MIN && p<=Z3_MAX) return 100;
  if(i!==3 && p>=Z2_MIN && p<=Z2_MAX) return 100;
  return 50;
}

function weekIndex(week){
  let data = getWeekData(week);
  let sum = 0;
  let longDone = 0;

  data.forEach((d,i)=>{
    let s = 0;
    if(d.done) s+=50;
    s += pulseScore(i,d.avg)*0.3;
    if(i===5 && d.done) longDone=1;
    sum+=s;
  });

  let base = Math.round(sum/7);
  if(longDone) base+=5;
  return Math.min(base,100);
}

function avg4(){
  let start = Math.max(1,currentWeek-3);
  let total=0,count=0;
  for(let w=start;w<=currentWeek;w++){
    total+=weekIndex(w);
    count++;
  }
  return Math.round(total/count);
}

function render(){
  let data = getWeekData(currentWeek);
  let container=document.getElementById("days");
  container.innerHTML="";

  let target=getWeekTarget(currentWeek);
  document.getElementById("weekInfo").innerText=
    "Целевой вес: "+target.weight+" кг | Длительный: "+target.long+" ч";

  data.forEach((d,i)=>{
    container.innerHTML+=`
      <div class="card">
        <strong>${days[i]}</strong>
        <input type="number" placeholder="Средний пульс"
          value="${d.avg||""}" onchange="update(${i},this.value)">
        <button onclick="toggle(${i})">${d.done?"Выполнено":"Отметить"}</button>
      </div>`;
  });

  let value=avg4();
  let offset=440 - (440*value/100);

  let ring=document.getElementById("ringProgress");
  ring.style.strokeDashoffset=offset;

  let color="#22c55e";
  let status="ГОТОВ";

  if(value<85){color="#facc15"; status="БЛИЗКО";}
  if(value<75){color="#ef4444"; status="НУЖНА СТАБИЛЬНОСТЬ";}

  ring.style.stroke=color;
  document.getElementById("ringText").innerText=value+"%";
  let st=document.getElementById("statusText");
  st.innerText=status;
  st.className="status "+(value>=85?"green":value>=75?"yellow":"red");
}

function update(i,val){
  let data=getWeekData(currentWeek);
  data[i].avg=Number(val);
  localStorage.setItem("elbrusData",JSON.stringify(allData));
  render();
}

function toggle(i){
  let data=getWeekData(currentWeek);
  data[i].done=!data[i].done;
  localStorage.setItem("elbrusData",JSON.stringify(allData));
  render();
}

function changeWeek(w){
  currentWeek=Number(w);
  render();
}

function init(){
  let sel=document.getElementById("weekSelector");
  for(let i=1;i<=TOTAL_WEEKS;i++){
    let opt=document.createElement("option");
    opt.value=i;
    opt.text="Неделя "+i;
    sel.appendChild(opt);
  }
  sel.value=1;
  render();
}

init();
</script>

</body>
</html>
